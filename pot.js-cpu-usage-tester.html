<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pot.js - CPU usage tester</title>
<link rel="shortcut icon" href="./img/favicon/potjs-favicon.png">
<link rel="Pot.js Repository - GitHub" href="http://github.com/polygonplanet/Pot.js">
<link rel="Pot.js Blog" href="http://potjs.tumblr.com/">
<link rel="author" title="polygon planet" href="http://polygonpla.net/">
<script src="./js/google/analytics.js?ua=UA-30496045-9"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="./js/pot/1.19/pot.min.js"></script>
<script>
$(function() {
  'use strict';

  var speed = 'normal';
  var max   = 0;
  var lang  = Pot.LANG === 'ja' && Pot.LANG || 'en';

  init();


  function init() {
    initLang();
    toggleLang($('.lang-toggle'), true);
    togglePotSpeed($('[name="loop-by"]:checked'));

    $('[name="loop-by"]').click(function() {
      togglePotSpeed($(this));
    });

    $('#run').click(function() {
      var that = $(this), label = that.text();

      resetResult();
      that.attr({disabled : true}).text('Processing...');

      Pot.callLazy(function() {
        return run();
      }).then(function() {
        that.removeAttr('disabled').text(label);
      });
    });
  }


  function run() {
    var loopBy = $('[name="loop-by"]:checked').val();
    var items = [];

    max   = $('#loop-count :selected').val() - 0;
    speed = $(((lang === 'ja') ? '#speed-lang-ja' : '#speed') + ' :selected').val();

    resetResult();

    return Pot.begin(function() {
      return Pot.Deferred.repeat.ninja(max, function(i) {
        items[i] = i;
      });
    }).then(function() {
      var func, callback, time, next, loopName, d = new Pot.Deferred();

      switch (loopBy) {
        case 'pot':
            loopName = 'Pot.Deferred.forEach()';
            func = asyncPotForEach;
            break;
        case 'jsfor':
            loopName = 'JavaScript for(...) loop';
            func = asyncForLoop;
            break;
        case 'jquery':
            loopName = 'jQuery.each()';
            func = asyncjQueryEach;
            break;
      }

      callback = function(key, val) {
        void function() {
          return new Array(1000).join('x').replace(/x/, '');
        }();

        var nop = progress(key, items.length);
      };

      next = function() {
        var container = $('.result-container'),
            descContainer = $('.result-desc-container');

        time = +new Date() - time;

        $('<div/>')
          .text(loopName)
          .css({fontWeight : 'bold'})
          .appendTo(container);

        $('<div/>')
          .text(time + 'ms.')
          .appendTo(container);

        $('<div/>')
          .text('------------')
          .appendTo(container);

        if (descContainer.children().length === 0) {
          $('<div/>')
            .text(
              (lang === 'en') ?
              'Refer your CPU load monitoring history, and compare each loops.' :
              'CPU 使用率のグラフを各ループで比較してみてください'
            )
            .appendTo(descContainer);
        }
        d.begin();
      };

      time = +new Date();
      func(items, callback, next);

      return d;
    });
  }


  function togglePotSpeed(target) {
    var selectSpeed = $('#speed,#speed-lang-ja');

    if (target.val() === 'pot') {
      selectSpeed.removeAttr('disabled');
    } else {
      selectSpeed.attr({disabled : true});
    }
    resetResult();
  }


  function resetResult() {
    $('.progress').text('');
  }


  function progress(current, total) {
    var per = Math.max(0, Math.min(100, Math.round((current / total) * 100)));

    //XXX: progress not work in jQuery.each.
    //$('.progress').text(per + '%');
    var p = $('.progress').eq(1);
    var nop = new Array(100).join('x').replace(/x(?:nop)?/i, 'v');
    return [per, p, nop];
  }


  // Pot.js - Pot.Deferred.forEach loop.
  function asyncPotForEach(items, callback, next) {
    Pot.Deferred.forEach[speed](items, function(val, key) {
      callback(key, val);
    }).then(function() {
      next();
    });
  }


  // jQuery - jQuery.each loop.
  function asyncjQueryEach(items, callback, next) {
    setTimeout(function() {
      $.each(items, function(key, val) {
        callback(key, val);
      });
      next();
    }, 0);
  }


  // JavaScript - for loop.
  function asyncForLoop(items, callback, next) {
    setTimeout(function() {
      var len = items.length;
      for (var i = 0; i < len; i++) {
        callback(i, items[i]);
      }
      next();
    }, 0);
  }


  function getLang(full) {
    return (lang === 'ja') ? (full ? 'English'  : 'en')
                           : (full ? 'Japanese' : 'ja');
  }


  function initLang() {
    $('<a/>')
      .addClass('lang-toggle')
      .attr({
        href  : Pot.JS_VOID_URI,
        title : getLang(true)
      })
      .text(getLang(true))
      .click(function() {
        toggleLang($(this));
      })
      .appendTo('.lang');
  }


  function toggleLang(elem, asis) {
    var en = $('.lang-en'),
        ja = $('.lang-ja'),
        speedEn = $('#speed'),
        speedJa = $('#speed-lang-ja');

    if (!asis) {
      lang = getLang();
    }

    if (lang === 'ja') {
      en.hide();
      ja.show();
      speedEn.hide();
      speedJa.show();
    } else {
      ja.hide();
      en.show();
      speedJa.hide();
      speedEn.show();
    }

    if (elem) {
      $(elem)
        .attr({title : getLang(true)})
        .text(getLang(true));
    }
  }

});
</script>
<style>
:focus {
  outline: 0;
}

body {
  font-family: verdana, sans-serif;
}

h1 {
  margin-bottom: 0.1em;
}

.desc, .loop-settings {
  margin: 1.5em;
  padding-bottom: 1em;
  border-bottom: 1px dashed;
}

.desc {
  margin-top: 0.2em;
}

.progress {
  font-weight: bold;
  color: #F00;
}

.result-container, .result-desc-container {
  color: #F00;
}

.progress, .footer, .run-container, .result-container {
  margin: 1.5em;
}

#run {
  font-weight: bold;
  font-size: 150%;
  padding: 0.2em 0.8em;
}

#loop-count, .loop-by-container, #speed, #speed-lang-ja {
  margin-left: 2em;
}

.loop-by-container div {
  margin-bottom: 0.2em;
}

.lang {
  text-align: right;
  margin-right: 3em;
}

.footer {
  line-height: 1.5;
}

#speed-lang-ja, .lang-ja {
  display: none;
}
</style>
</head>
<body>
  <div style="border: 2px solid red; padding: 0 5px; color: #910202; background-color: #fff;">
    このライブラリは現在メンテナンスされていません。
    CPU負荷を抑えて重い処理を軽くするJavaScriptライブラリは <a href="https://github.com/polygonplanet/chillout">chillout.js</a> をお使いください。
    <br>
    This repository is no longer maintained.
    To reduce JavaScript CPU usage by asynchronous iteration, use <a href="https://github.com/polygonplanet/chillout">chillout.js</a> instead.
  </div>
  <h1>Pot.js - CPU usage tester</h1>
  <div class="lang"></div>
  <div class="desc">
    <div class="lang-en">
      <h3>See your browser's CPU usage.</h3>
      <p>
        (e.g. on Windows: Under the Performance tab in Task Manager, a user can monitor CPU usage.)
        <br>
        or use any CPU monitoring application.
      </p>
      <p>
        Next, setting loops and click "Run" button.
      </p>
      <p>
        The most important thing of performance in JavaScript, that is not numeric speed, but is to execute without causing stress to the UI.
        <br>
        Pot.js can be performed without causing stress to the UI and the CPU load by using easy loop iteration functions.
        <br>
        Also, you will notice that Pot.js iterator does not occur the &quot;Warning: Unresponsive script&quot; prompt.
      </p>
    </div>
    <div class="lang-ja">
      <h3>ブラウザの CPU 使用率を確認できる状態にしてください</h3>
      <p>
        例えば Windows ならタスクマネージャの「パフォーマンス」タブから CPU 使用率が確認できます。
        <br>
        もしくは、使い慣れた CPU モニタリング可能なアプリがあればそれを利用します。
      </p>
      <p>
        CPU グラフを確認できる状態になったら、任意にループの設定をして「Run」ボタンを押します。
      </p>
      <p>
        Web ページで実行される JavaScript において、重要なのは数値的な速度ではなく、UI へのストレスを減らし
        常にブラウザに応答し 処理の重さを感じさせないことです。
        <br>
        Pot.js は、ループ処理における CPU 負荷を抑え UI にストレスを与えることなく JavaScript を実行できます。
        <br>
        そして、各ループを比較すると
        Pot.js のイテレータは「応答のないスクリプト」警告を発生させずに実行できていることに気付けると思います。
      </p>
    </div>
  </div>

  <div class="loop-settings">
    <div>
      <p>
        <strong>
          <span class="lang-en">Select Loop Count: (Note to browser freeze!)</span>
          <span class="lang-ja">ループ回数: (ブラウザのフリーズに注意!)</span>
        </strong>
      </p>
      <select id="loop-count">
        <option value="100">100</option>
        <option value="1000">1000</option>
        <option value="10000">10000</option>
        <option value="100000" selected="selected">100000</option>
        <option value="1000000">1000000</option>
        <option value="10000000">10000000</option>
        <option value="100000000">100000000</option>
      </select>
    </div>
    <div>
      <p>
        <strong>
          <span class="lang-en">Select Loop function/statement:</span>
          <span class="lang-ja">ループする関数/文:</span>
        </strong>
      </p>
      <div class="loop-by-container">
        <div><label><input type="radio" name="loop-by" value="jquery">jQuery.each()</label></div>
        <div><label><input type="radio" name="loop-by" value="jsfor">JavaScript for(...) loop</label></div>
        <div><label><input type="radio" name="loop-by" value="pot" checked="checked">Pot.Deferred.forEach()</label></div>
      </div>
    </div>

    <div class="potjs-iterator-speed-container">
      <p>
        <strong>
          <span class="lang-en">Pot.js Iterator Speed:</span>
          <span class="lang-ja">Pot.js イテレータの速度:</span>
        </strong>
      </p>
      <select id="speed">
        <option value="ninja">fastest</option>
        <option value="rapid" selected="selected">faster</option>
        <option value="fast">fast</option>
        <option value="normal">normal</option>
        <option value="slow">slowly</option>
        <option value="doze">more slowly</option>
        <option value="limp">most slowly</option>
      </select>
      <select id="speed-lang-ja">
        <option value="ninja">もっと速く</option>
        <option value="rapid" selected="selected">速く</option>
        <option value="fast">少し速く</option>
        <option value="normal">通常</option>
        <option value="slow">少し遅く</option>
        <option value="doze">遅く</option>
        <option value="limp">もっと遅く</option>
      </select>
    </div>
  </div>

  <div class="run-container">
    <button type="button" id="run">Run</button>
  </div>

  <div class="progress"></div>

  <div class="result-container"></div>
  <div class="result-desc-container"></div>

  <div class="footer">
    <h3>Download</h3>
    <div>
      <ul>
        <li><a href="http://github.com/polygonplanet/Pot.js/zipball/master"
               title="Pot.js + PotLite.js - latest zip"
               style="font-size: 120%; font-weight: bold;">Download zip</a>
        </li>
      </ul>
    </div>
    <p>
      <a href="http://polygonplanet.github.com/Pot.js/"><strong>Pot.js + PotLite.js - Document and Reference</strong></a>
      <br>
      <a href="https://github.com/polygonplanet/Pot.js"><strong>Pot.js - GitHub</strong></a>
    </p>
    <p>2012 &copy; <a href="http://twitter.com/polygon_planet">polygon planet</a></p>
  </div>
</body>
</html>